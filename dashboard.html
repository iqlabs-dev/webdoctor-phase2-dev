<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebDoctor Dashboard</title>
</head>
<body>
  <h2>Welcome to WebDoctor</h2>

  <div>
    <input id="scan-url" placeholder="https://website.com">
    <button id="run-scan">Run Scan</button>
  </div>

  <h3>My Reports</h3>
  <div id="reports-list"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest"></script>

  <script>
    // Initialize Supabase + Clerk
    const supa = supabase.createClient(
      'https://arqlambmnbrgjcvwiand.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycWxhbWJtbmJyZ2pjdndpYW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzg5NzgsImV4cCI6MjA3NzcxNDk3OH0.2uGkC8vNjy5ZttMUOKCuThtCSUNrQBGZ1-zb39sCzVU'
    );

    let currentUser = null;
    let currentPlan = null;

    window.addEventListener("load", async () => {
      await Clerk.load();
      if (!Clerk.user) {
        Clerk.redirectToSignIn();
        return;
      }

      currentUser = Clerk.user;
      currentPlan = await ensureUserPlan();
      loadReports();
      document.getElementById('run-scan').onclick = runScan;
    });

    // --------------------------------------------------------
    // Ensure User Plan (3-day, 5-report trial)
    // --------------------------------------------------------
    async function ensureUserPlan() {
      const userId = currentUser.id;

      const { data, error } = await supa
        .from('user_plans')
        .select('*')
        .eq('user_id', userId)
        .maybeSingle();

      if (error) {
        console.error('plan load error', error);
        return null;
      }

      if (!data) {
        const now = new Date();
        const trialEnds = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000); // +3 days

        const { error: insErr } = await supa
          .from('user_plans')
          .insert({
            user_id: userId,
            plan: 'trial',
            trial_started_at: now.toISOString(),
            trial_ends_at: trialEnds.toISOString(),
            reports_quota: 5,  // ðŸ‘ˆ sets 5-scan trial
          });

        if (insErr) console.error('plan insert err', insErr);

        return {
          user_id: userId,
          plan: 'trial',
          trial_started_at: now.toISOString(),
          trial_ends_at: trialEnds.toISOString(),
          reports_quota: 5,
          reports_used: 0
        };
      }

      return data;
    }

    // --------------------------------------------------------
    // Load Reports
    // --------------------------------------------------------
    async function loadReports() {
      const { data: reports, error } = await supa
        .from('reports')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading reports:', error.message);
        document.getElementById('reports-list').innerText = 'Error loading reports.';
        return;
      }

      const box = document.getElementById('reports-list');
      if (!reports || reports.length === 0) {
        box.innerHTML = 'No reports yet.';
        return;
      }

      box.innerHTML = reports
        .map(
          (r) => `
        <div style="margin-bottom:6px; border-bottom:1px solid #ddd; padding:6px 0;">
          <strong>${r.url}</strong><br>
          Score: ${r.score || '-'}<br>
          <button onclick="viewReport('${r.id}')">View Report</button>
        </div>
      `
        )
        .join('');
    }

    // --------------------------------------------------------
    // Run Scan
    // --------------------------------------------------------
    async function runScan() {
      const now = new Date();

      // Trial checks
      if (currentPlan.plan === 'trial') {
        if (currentPlan.trial_ends_at && now > new Date(currentPlan.trial_ends_at)) {
          alert('Your trial has ended. Please subscribe to continue.');
          return;
        }

        if ((currentPlan.reports_used || 0) >= (currentPlan.reports_quota || 5)) {
          alert('You have used all 5 trial scans. Please upgrade to continue.');
          return;
        }
      }

      const url = document.getElementById('scan-url').value.trim();
      if (!url) return alert('Enter a website URL');

      const res = await fetch('/.netlify/functions/generate-report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url,
          user_id: currentUser.id,
          email: currentUser.primaryEmailAddress?.emailAddress
        })
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch (e) {}

      if (res.ok) {
        // Update usage count
        const newUsed = (currentPlan.reports_used || 0) + 1;
        await supa
          .from('user_plans')
          .update({
            reports_used: newUsed,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id);

        currentPlan.reports_used = newUsed;
        alert('Scan completed and saved!');
        loadReports();
      } else {
        alert('Error: ' + text);
      }
    }

    // --------------------------------------------------------
    // View Report
    // --------------------------------------------------------
    async function viewReport(reportId) {
      const { data, error } = await supa
        .from('reports')
        .select('html')
        .eq('id', reportId)
        .maybeSingle();

      if (error || !data) {
        alert('Error loading report.');
        return;
      }

      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(data.html);
      reportWindow.document.close();
    }
  </script>
</body>
</html>

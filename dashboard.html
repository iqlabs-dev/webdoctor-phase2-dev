<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iQWEB ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-top: #050814;
      --bg-mid: #07101f;
      --bg-bot: #0b1729;
      --ink: #e8eef2;
      --ink-soft: #c7d9e7;
      --muted: #9fb1bf;
      --highlight: #5dd8ff;
      --danger: #ff6b6b;
      --box: rgba(255,255,255,0.06);
      --box2: rgba(255,255,255,0.12);
    }

    .subscription-banner {
      margin-bottom: 20px;
      padding: 14px 18px;
      border-radius: 18px;
      background: radial-gradient(circle at top left, rgba(34,211,238,0.18), rgba(15,23,42,0.96));
      border: 1px solid rgba(148,163,184,0.55);
      box-shadow: 0 16px 40px rgba(0,0,0,0.6);
    }

    .subscription-banner__title {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .subscription-banner__text {
      font-size: 0.8rem;
      color: #c0cfeb;
      margin: 0 0 12px;
    }

    .subscription-banner__button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #14b8a6);
      color: #020617;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Montserrat, sans-serif;
      background: radial-gradient(circle at top left, #10172a 0, #050814 45%, #02040a 100%);
      color: var(--ink);
      overflow-x: hidden;
    }

    /* HEADER */

    header {
      position: sticky;
      top: 0;
      z-index: 30;
      padding: 22px 40px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.1));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 26px;
    }

    .logo a {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--ink);
      text-decoration: none;
    }

    .back-link {
      font-size: 16px;
      color: var(--ink-soft);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      opacity: 0.9;
      transition: 0.2s;
    }

    .back-link span.arrow {
      font-size: 18px;
      margin-top: -1px;
    }

    .back-link:hover {
      color: var(--highlight);
      opacity: 1;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 26px;
    }

    .nav-link {
      font-size: 17px;
      font-weight: 600;
      color: var(--ink-soft);
      text-decoration: none;
      transition: 0.2s;
    }

    .nav-link.active {
      color: var(--highlight);
    }

    .nav-link:hover {
      color: var(--ink);
    }

    .user-menu {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .user-trigger {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: rgba(8,15,30,0.9);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      cursor: pointer;
      font-size: 14px;
      color: var(--ink-soft);
      outline: none;
    }

    .user-initial {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--highlight), #8be7ff);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: 800;
      font-size: 15px;
    }

    .user-email {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-caret {
      font-size: 11px;
      opacity: 0.8;
      margin-left: 4px;
    }

    .user-admin-badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      padding: 2px 6px;
      color: var(--highlight);
    }

    .user-dropdown {
      position: absolute;
      right: 0;
      top: 110%;
      background: #040712;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      min-width: 230px;
      padding: 8px;
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: 0.16s ease-out;
    }

    .user-menu:hover .user-dropdown {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .user-dropdown a,
    .user-dropdown button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      text-decoration: none;
      color: var(--ink-soft);
      transition: 0.16s;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
    }

    .user-dropdown a:hover,
    .user-dropdown button:hover {
      background: rgba(255,255,255,0.05);
      color: var(--ink);
    }

    .user-dropdown a.signout {
      color: var(--danger);
      font-weight: 600;
    }

    .user-dropdown-separator {
      height: 1px;
      margin: 6px 4px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
    }

    /* PAGE WRAP */

    .wrap {
      max-width: 1200px;
      margin: 34px auto 60px;
      padding: 0 20px 40px;
    }

    .section {
      background: var(--box);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.09);
      box-shadow: 0 0 40px rgba(0,0,0,0.45);
      padding: 32px 34px;
      margin-bottom: 30px;
    }

    .section.small {
      padding: 24px 26px;
    }

    h1 {
      font-size: 36px;
      margin: 0 0 6px;
      font-weight: 800;
      color: var(--highlight);
    }

    .subtext {
      font-size: 18px;
      color: var(--ink-soft);
      margin-bottom: 24px;
      line-height: 1.55;
    }

    .subtext strong {
      color: var(--highlight);
      font-weight: 600;
    }

    /* PLAN BANNER (Linear-style plan confirmation) */

    .plan-banner {
      background: rgba(34, 211, 238, 0.08);
      border: 1px solid rgba(34,211,238,0.55);
      border-radius: 14px;
      padding: 12px 16px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
      color: var(--ink-soft);
    }

    .plan-banner strong {
      color: var(--ink);
    }

    .checkout-btn {
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid rgba(34,211,238,0.8);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617);
      color: var(--ink-soft);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 28px rgba(15,23,42,0.85);
      transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease, transform 0.18s ease;
    }

    .checkout-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(34,211,238,1);
      color: var(--ink);
    }

    /* SUMMARY CARD */

    .summary-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 26px;
      align-items: stretch;
    }

    .summary-block {
      background: var(--box2);
      border-radius: 16px;
      padding: 22px 24px;
      border: 1px solid rgba(255,255,255,0.09);
    }

    .summary-label {
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .credits-value {
      font-size: 34px;
      font-weight: 800;
      color: var(--highlight);
      transition: color 0.15s;
    }

    .credits-value.low-credits {
      color: #fb923c;
    }

    .plan-remaining-row {
      margin-top: 6px;
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .plan-remaining-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: var(--muted);
    }

    .plan-remaining-value {
      font-weight: 700;
      color: var(--ink-soft);
    }

    .credits-pack-row {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .credits-pack-label {
      width: 100%;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .credits-pack-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.65);
      background: rgba(8,15,30,0.9);
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      color: var(--ink-soft);
      cursor: pointer;
      transition: background 0.16s ease, border-color 0.16s ease, transform 0.1s ease;
    }

    .credits-pack-btn:hover {
      background: rgba(34,211,238,0.14);
      border-color: rgba(34,211,238,0.9);
      transform: translateY(-1px);
      color: var(--ink);
    }

    .hint-text {
      font-size: 14px;
      color: var(--muted);
    }

    /* INLINE RUN STRIP */

    .run-strip {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    .run-strip-btn,
    .run-strip-input {
      flex: 1 1 0;
      display: flex;
    }

    .run-strip-input input {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(4,8,18,0.9);
      color: var(--ink);
      padding: 12px 14px;
      font-size: 14px;
      outline: none;
    }

    .run-strip-input input::placeholder {
      color: var(--muted);
    }

    /* Run button */

    .btn-primary {
      width: 100%;
      justify-content: center;
      padding: 14px 20px;
      border-radius: 14px;
      background: linear-gradient(135deg, #22c55e, #14b8a6);
      color: #000;
      font-weight: 800;
      font-size: 16px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out, opacity 0.16s;
      border: none;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary span.icon {
      font-size: 18px;
      margin-top: -1px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(0,0,0,0.7);
      opacity: 0.92;
    }

    /* PREMIUM LATEST SCAN CARD */

    .latest-scan-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 20px;
      padding: 28px 26px;
      text-align: center;
      cursor: pointer;
      transition: background 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
    }

    .latest-scan-card:hover {
      background: rgba(255, 255, 255, 0.06);
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
    }

    .ls-label {
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      color: #38bdf8;
      margin-bottom: 18px;
    }

    .ls-url {
      font-size: 1.25rem;
      font-weight: 700;
      color: #e2e8f0;
    }

    .ls-date {
      margin-top: 6px;
      font-size: 0.92rem;
      color: #cbd5e1;
    }

    .ls-score-box {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .ls-score-pill {
      background: #0ea5e9;
      padding: 6px 16px;
      color: white;
      font-weight: 700;
      border-radius: 40px;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .ls-score-text {
      font-size: 0.85rem;
      color: #cbd5e1;
    }

    .ls-footer {
      margin-top: 22px;
      display: flex;
      justify-content: center;
      gap: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #38bdf8;
      align-items: center;
      opacity: 0.85;
      transition: opacity 0.2s;
    }

    .latest-scan-card:hover .ls-footer {
      opacity: 1;
    }

    .ls-arrow {
      opacity: 0.85;
    }

    .latest-scan-card:hover .ls-arrow {
      opacity: 1;
    }

    /* LAYOUT GRID */

    .layout-grid {
      display: block;
    }

    h2 {
      font-size: 24px;
      margin: 0 0 10px;
    }

    /* HISTORY HEADER / SEARCH / FILTERS */

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      margin-bottom: 10px;
    }

    .history-header-left {
      flex: 1 1 auto;
    }

    .history-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      min-width: 260px;
    }

    .filter-pills {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filter-pill {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(10,15,32,0.9);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
    }

    .filter-pill.active {
      border-color: var(--highlight);
      color: var(--ink);
      background: rgba(12,26,56,0.95);
    }

    .search-group {
      position: relative;
      width: 100%;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(4,8,18,0.9);
      color: var(--ink);
      padding: 7px 12px 7px 30px;
      font-size: 13px;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    .search-icon {
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      color: var(--muted);
      pointer-events: none;
    }

    /* TABLE */

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 14px 10px;
      font-size: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    th {
      text-align: left;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    td {
      color: var(--ink);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(95,248,187,0.12);
      color: #6cfac3;
    }

    .status-pill.pending {
      background: rgba(255,204,102,0.15);
      color: #ffd27a;
      position: relative;
      padding-left: 24px;
    }

    .status-pill.pending::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(255,210,122,0.8);
      border-top-color: transparent;
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: translateY(-50%) rotate(360deg);
      }
    }

    .action-link {
      color: var(--highlight);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      margin-right: 10px;
    }

    .action-link:hover {
      text-decoration: underline;
    }

    /* Report ID style + copy button */

    .report-id-btn {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }

    .report-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      letter-spacing: 0.04em;
      color: var(--ink-soft);
      transition: color 0.12s;
    }

    .report-id-btn:hover .report-id {
      color: var(--highlight);
    }

    /* History footer / load more */

    .history-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(7,12,24,0.9);
      color: var(--ink-soft);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      transition: 0.16s;
      cursor: pointer;
    }

    .btn-secondary.small {
      padding: 7px 14px;
      font-size: 12px;
      border-radius: 999px;
    }

    .btn-secondary:hover {
      background: rgba(15,25,42,0.98);
      color: var(--ink);
    }

    /* Empty states */

    .history-empty {
      display: none;
      margin-top: 12px;
      padding: 18px 16px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,0.2);
      background: rgba(4,8,20,0.85);
      font-size: 14px;
      color: var(--ink-soft);
    }

    .history-empty strong {
      color: var(--highlight);
    }

    /* Copy toast */

 #copyToast {
  position: fixed;
  left: 50%;
  bottom: 26px;
  transform: translateX(-50%) translateY(20px);
  padding: 10px 18px;
  border-radius: 999px;
  background: rgba(12,20,40,0.96);
  border: 1px solid rgba(255,255,255,0.18);
  color: var(--ink-soft);
  font-size: 13px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.16s ease-out, transform 0.16s ease-out;
  z-index: 60;
}


    #copyToast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 960px) {
      header {
        padding: 18px 18px;
      }

      .header-left {
        gap: 16px;
      }

      .wrap {
        margin-top: 24px;
      }

      .summary-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .history-header {
        flex-direction: column;
        align-items: stretch;
      }

      .history-controls {
        align-items: stretch;
        min-width: 0;
      }

      .filter-pills {
        justify-content: flex-start;
      }
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 30px;
      }

      .section {
        padding: 24px 20px;
      }

      .section.small {
        padding: 20px 18px;
      }

      .subtext {
        font-size: 16px;
      }

      .user-trigger {
        padding: 6px 10px;
      }

      .run-strip {
        flex-direction: column;
      }

      .plan-banner {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .wd-pdf-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: #e0f2fe;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }

    .wd-pdf-btn:hover {
      background: rgba(56, 189, 248, 0.18);
      border-color: rgba(56, 189, 248, 1);
      transform: translateY(-1px);
    }

    .scan-actions-pending {
      font-size: 0.8rem;
      color: #64748b;
    }

    /* WEBSITE column as blue, hyperlink-style text */
    .history-site-link {
      color: var(--highlight);
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      max-width: 100%;
    }

    .history-site-link:hover {
      text-decoration: underline;
    }

  </style>
</head>

<body>

<header>
  <div class="header-left">
    <div class="logo">
      <a href="index.html">iQWEB</a>
    </div>
    <a class="back-link" href="index.html">
      <span class="arrow">‚Üê</span>
      <span>Back to main page</span>
    </a>
  </div>

  <div class="header-right">
    <a href="#" class="nav-link active">Dashboard</a>

    <div class="user-menu">
      <button class="user-trigger" type="button">
        <span class="user-initial" id="wd-user-initial">U</span>
        <span class="user-email" id="wd-user-email">you@example.com</span>
        <span id="wd-admin-badge" class="user-admin-badge" style="display:none;">Admin</span>
        <span class="user-caret">‚ñæ</span>
      </button>
      <div class="user-dropdown">
        <a href="#">Profile</a>
        <button type="button">Buy extra credits</button>
        <button type="button">Manage subscription &amp; invoices</button>
        <div class="user-dropdown-separator"></div>
        <button type="button">Support</button>
        <a href="https://trust.webdoctor.tech" target="_blank">Trust &amp; privacy</a>
        <div class="user-dropdown-separator"></div>
        <a href="#" class="signout">Sign out</a>
      </div>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- SUMMARY / TOP STRIP -->
  <div class="section">
    <h1>Welcome back, <span id="wd-user-name">there</span></h1>
    <div class="subtext">
      <strong>Scan</strong> ‚Äî run instant website health checks.<br>
      <strong>View</strong> ‚Äî access your latest and past scans.<br>
      <strong>Share</strong> ‚Äî download reports anytime.<br>
      All from one place.
    </div>

    <!-- SUBSCRIPTION REQUIRED BANNER -->
    <div id="subscription-banner" class="subscription-banner" style="display:none;">
      <div class="subscription-banner__title">
        Choose your iQWEB plan to continue
      </div>
      <p class="subscription-banner__text">
        Your account is active, but you don‚Äôt have a subscription yet.
        Purchase a plan to unlock scans and full dashboard features.
      </p>
      <button id="btn-go-to-pricing" class="subscription-banner__button">
        View plans &amp; subscribe
      </button>
    </div>

    <!-- Linear-style plan banner (only shows if ?plan= is present) -->
    <div id="selected-plan-banner" class="plan-banner" style="display:none;">
      <p id="selected-plan-text"></p>
      <button id="selected-plan-cta" class="checkout-btn" type="button">
        Continue to checkout
      </button>
    </div>

<div class="summary-grid">
  <!-- LEFT: TOTAL SCANS + RUN SCAN -->
  <div class="summary-block">
    <div class="summary-label">Total scans available</div>
    <div class="credits-value" id="wd-credits-count">--</div>

    <div class="plan-remaining-row">
      <span class="plan-remaining-label">Monthly subscription scans remaining</span>
      <span class="plan-remaining-value" id="wd-plan-scans-remaining">--</span>
    </div>

    <div class="hint-text" id="wd-plan-summary" style="margin-top:8px;">
      Loading your plan details‚Ä¶
    </div>

    <div class="run-strip">
      <div class="run-strip-btn">
        <button id="wd-run-scan-btn" class="btn-primary" type="button">
          <span class="icon">‚ñ∂</span>
          <span>Run Scan</span>
        </button>
      </div>
      <div class="run-strip-input">
        <input
          id="wd-scan-url-input"
          type="text"
          placeholder="Paste a URL to scan (e.g. https://example.com)">
      </div>
    </div>

    <div class="hint-text" style="margin-top:8px;">
      Your subscription scans are used first. If you run out, extra credits are $1 per scan.
    </div>

    <div class="credits-pack-row">
      <div class="credits-pack-label">Top up your credits</div>
      <button id="btn-credits-10" class="credits-pack-btn" type="button">+10 scans</button>
      <button id="btn-credits-25" class="credits-pack-btn" type="button">+25 scans</button>
      <button id="btn-credits-50" class="credits-pack-btn" type="button">+50 scans</button>
      <button id="btn-credits-100" class="credits-pack-btn" type="button">+100 scans</button>
      <button id="btn-credits-500" class="credits-pack-btn" type="button">+500 scans</button>
    </div>
  </div>

  <!-- RIGHT: latest scan card (your existing block) -->
  <div class="summary-block">
    <!-- latest scan card exactly as you already have -->
    ...
  </div>
</div>


  <div class="hint-text" style="margin-top:8px;">
    Your subscription scans are used first. If you run out, extra credits are $1 per scan.
  </div>

  <div class="credits-pack-row">
    <div class="credits-pack-label">Top up your credits</div>
    <button id="btn-credits-10" class="credits-pack-btn" type="button">+10 scans</button>
    <button id="btn-credits-25" class="credits-pack-btn" type="button">+25 scans</button>
    <button id="btn-credits-50" class="credits-pack-btn" type="button">+50 scans</button>
    <button id="btn-credits-100" class="credits-pack-btn" type="button">+100 scans</button>
    <button id="btn-credits-500" class="credits-pack-btn" type="button">+500 scans</button>
  </div>
</div>


  <div class="hint-text" style="margin-top:8px;">
    Your plan scans are used first. If you run out, extra credits are $1 per scan.
  </div>

  <div class="credits-pack-row">
    <div class="credits-pack-label">Top up your credits</div>
    <button id="btn-credits-10" class="credits-pack-btn" type="button">+10 scans</button>
    <button id="btn-credits-25" class="credits-pack-btn" type="button">+25 scans</button>
    <button id="btn-credits-50" class="credits-pack-btn" type="button">+50 scans</button>
    <button id="btn-credits-100" class="credits-pack-btn" type="button">+100 scans</button>
    <button id="btn-credits-500" class="credits-pack-btn" type="button">+500 scans</button>
  </div>
</div>

      <!-- NEW PREMIUM LATEST SCAN CARD -->
      <div class="summary-block">
        <div id="latest-scan-card" class="latest-scan-card">
          <div class="ls-label">LATEST SCAN</div>
          <div class="ls-body">
            <div id="ls-url" class="ls-url">No scans yet</div>
            <div id="ls-date" class="ls-date">Run your first iQWEB scan to see it here.</div>
            <div class="ls-score-box">
              <span id="ls-score" class="ls-score-pill" style="display:none;">‚Äî</span>
              <span class="ls-score-text">Overall score</span>
            </div>
          </div>
          <div class="ls-footer">
            <span>View full report</span>
            <svg class="ls-arrow" width="16" height="16" viewBox="0 0 24 24">
              <path fill="currentColor" d="M9 18l6-6-6-6"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN GRID: HISTORY ONLY -->

  <div class="layout-grid">

    <div class="section">
      <div class="history-header">
        <div class="history-header-left">
          <h2>Scan history</h2>
          <div class="hint-text">
            All the websites you‚Äôve scanned with iQWEB. Open a report or download the PDF anytime.
          </div>
        </div>
        <div class="history-controls">
          <div class="filter-pills">
            <button class="filter-pill active" data-status="all">All</button>
            <button class="filter-pill" data-status="completed">Completed</button>
            <button class="filter-pill" data-status="in-progress">In progress</button>
          </div>
          <div class="search-group">
            <span class="search-icon">üîç</span>
            <input id="historySearch" class="search-input" type="search"
                   placeholder="Search scans‚Ä¶ (domain, date, ID)">
          </div>
        </div>
      </div>

      <table class="scan-history-table">
        <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Website</th>
          <th>Score</th>
          <th>Status</th>
          <th>Report ID</th>
          <th style="text-align:right;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- rows injected dynamically -->
        </tbody>
      </table>

      <div id="historyEmptyNone" class="history-empty">
        <strong>No scans yet.</strong> Run your first iQWEB scan and it will appear here.
      </div>

      <div id="historyEmptyFiltered" class="history-empty">
        <strong>No scans match your search.</strong> Try clearing filters or changing your search terms.
      </div>

      <div class="history-footer">
        <button id="loadMoreScans" type="button" class="btn-secondary small" style="display:none;">
          Load more scans
        </button>
      </div>
    </div>

  </div>

</div>

<div id="copyToast">Report ID copied to clipboard</div>

<footer style="
  position: fixed;
  right: 24px;
  bottom: 18px;
  color: rgba(231,239,245,0.45);
  font-size: 12px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  pointer-events: none;
">
  Powered by <span style="color:#5dd8ff;">iQWEB</span>
</footer>

<!-- Supabase auth + profile + scan history + inline scan wiring -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://arqlambmnbrgjcvwiand.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycWxhbWJtbmJyZ2pjdndpYW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzg5NzgsImV4cCI6MjA3NzcxNDk3OH0.2uGkC8vNjy5ZttMUOKCuThtCSUNrQBGZ1-zb39sCzVU"; // keep your real key here

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function requireSession() {
    const { data, error } = await supabase.auth.getSession();

    if (error) {
      console.error("Error getting session", error);
      window.location.href = "/login.html";
      return null;
    }
    if (!data.session) {
      window.location.href = "/login.html";
      return null;
    }
    return data.session.user;
  }

  // -----------------------
  // PROFILE / PLAN SUMMARY
  // -----------------------
  async function loadProfile(user) {
    const { data, error } = await supabase
      .from("profiles")
      .select("full_name, email, credits, plan, plan_status, plan_scans_remaining, is_admin")
      .eq("user_id", user.id)
      .maybeSingle();

    if (error) {
      console.error("Error loading profile", error);
    }

    const profile = data || {};
    const displayEmail = profile.email || user.email || "";
    const displayName = profile.full_name || displayEmail || "iQWEB user";

    const nameEl = document.getElementById("wd-user-name");
    const emailEl = document.getElementById("wd-user-email");
    const initialEl = document.getElementById("wd-user-initial");
    const creditsEl = document.getElementById("wd-credits-count");
    const planSummaryEl = document.getElementById("wd-plan-summary");
    const adminBadgeEl = document.getElementById("wd-admin-badge");
    const planRemainingEl = document.getElementById("wd-plan-scans-remaining");
    const subscriptionBanner = document.getElementById("subscription-banner");

    if (nameEl) nameEl.textContent = displayName;
    if (emailEl) emailEl.textContent = displayEmail || "Signed in";
    if (initialEl) {
      initialEl.textContent = (displayName || "?").trim().charAt(0).toUpperCase();
    }

    const credits = Number.isFinite(profile.credits) ? profile.credits : 0;
    const plan = (profile.plan || "").toLowerCase();           // insight / intelligence / impact
    const planStatus = (profile.plan_status || "").toLowerCase(); // active / cancelled / ""
    const planScansRemaining = Number.isFinite(profile.plan_scans_remaining)
      ? profile.plan_scans_remaining
      : 0;

    // Big number: total scans available (plan + credits)
    const totalAvailable =
      (planStatus === "active" ? planScansRemaining : 0) + credits;

    if (creditsEl) {
      creditsEl.textContent = totalAvailable;
      creditsEl.classList.toggle("low-credits", totalAvailable <= 2);
    }

    // Small label row for "Plan scans remaining"
    if (planRemainingEl) {
      if (planStatus === "active") {
        planRemainingEl.textContent = planScansRemaining;
      } else {
        planRemainingEl.textContent = "‚Äî";
      }
    }

    // Human summary line under the number
    let summary;
    if (planStatus === "active" && plan) {
      const friendlyNameMap = {
        insight: "Insight",
        intelligence: "Intelligence",
        impact: "Impact",
      };
      const planName =
        friendlyNameMap[plan] ||
        plan.charAt(0).toUpperCase() + plan.slice(1);

      summary = `${planName} plan ‚Äî ${planScansRemaining} plan scans left this month`;
      if (credits > 0) {
        summary += ` ¬∑ ${credits} extra credits (never expire).`;
      } else {
        summary += `.`;
      }
    } else if (credits > 0) {
      summary = `Free plan ¬∑ ${credits} credits available (never expire).`;
    } else {
      summary = `No active plan yet. Choose a plan or buy credits to start scanning.`;
    }

    if (planSummaryEl) {
      planSummaryEl.textContent = summary;
    }

    // Show / hide the "Choose your plan" banner
    if (subscriptionBanner) {
      if (planStatus !== "active" && totalAvailable === 0) {
        subscriptionBanner.style.display = "block";
      } else {
        subscriptionBanner.style.display = "none";
      }
    }

    if (adminBadgeEl) {
      adminBadgeEl.style.display = profile.is_admin ? "inline-flex" : "none";
    }
  }

  // ---- Scan history + filters/search ----

  let allRecords = [];
  let activeStatus = "all";
  let searchQuery = "";

  function formatDate(dateString) {
    if (!dateString) return "‚Äî";
    const d = new Date(dateString);
    if (Number.isNaN(d.getTime())) return "‚Äî";
    const day = String(d.getDate()).padStart(2, "0");
    const month = d.toLocaleString("en-US", { month: "short" }).toUpperCase();
    const year = d.getFullYear();
    return `${day} ${month} ${year}`;
  }

  function formatTime(dateString) {
    if (!dateString) return "‚Äî";
    const d = new Date(dateString);
    if (Number.isNaN(d.getTime())) return "‚Äî";
    const hours = String(d.getHours()).padStart(2, "0");
    const mins = String(d.getMinutes()).padStart(2, "0");
    return `${hours}:${mins}`;
  }

  function getHostname(url) {
    if (!url) return "‚Äî";
    try {
      return new URL(url).hostname;
    } catch {
      return url;
    }
  }

  function getStatusKey(status) {
    const s = (status || "").toLowerCase();
    if (s === "in_progress" || s === "pending") return "in-progress";
    if (s === "failed" || s === "error") return "failed";
    return "completed";
  }

  function getStatusLabel(status) {
    const key = getStatusKey(status);
    if (key === "in-progress") return "In progress";
    if (key === "failed") return "Failed";
    return "Completed";
  }

  function getStatusClass(status) {
    const key = getStatusKey(status);
    if (key === "in-progress") return "status-pill pending";
    if (key === "failed") return "status-pill";
    return "status-pill";
  }

  function showToast(msg) {
    const toast = document.getElementById("copyToast");
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add("visible");
    setTimeout(() => toast.classList.remove("visible"), 1500);
  }

  // STEP 1: History rows ‚Üí View report + Download PDF, and latest-scan click
  function renderRows(records) {
    const table = document.querySelector(".scan-history-table");
    const tbody = table?.querySelector("tbody");
    if (!tbody || !table) return;

    tbody.innerHTML = "";

    for (const rec of records) {
      const tr = document.createElement("tr");
      tr.className = "scan-row";

      const created = rec.created_at ? new Date(rec.created_at) : null;

      const dateStr = created
        ? created
            .toLocaleDateString("en-NZ", {
              day: "2-digit",
              month: "short",
              year: "numeric",
            })
            .toUpperCase()
        : "-";

      const timeStr = created
        ? created.toLocaleTimeString("en-NZ", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          })
        : "-";

      const website = rec.url || rec.website || "-";
      const score = rec.score_overall ?? rec.score ?? "‚Äî";
      const statusRaw = (rec.status || "Pending").toString();
      const statusKey = getStatusKey(statusRaw);
      const reportId = rec.report_id || rec.id || "-";

      // DATE
      const tdDate = document.createElement("td");
      tdDate.textContent = dateStr;
      tr.appendChild(tdDate);

      // TIME
      const tdTime = document.createElement("td");
      tdTime.textContent = timeStr;
      tr.appendChild(tdTime);

      // WEBSITE (blue clickable, focuses this scan in Latest Scan card)
      const tdSite = document.createElement("td");
      tdSite.className = "history-site-link";
      tdSite.textContent = website;
      tdSite.title = website;
      tdSite.addEventListener("click", () => {
        updateLastScanCard(rec);
      });
      tr.appendChild(tdSite);

      // SCORE
      const tdScore = document.createElement("td");
      tdScore.textContent = score;
      tr.appendChild(tdScore);

      // STATUS
      const tdStatus = document.createElement("td");
      tdStatus.textContent = getStatusLabel(statusRaw);
      tdStatus.className = getStatusClass(statusRaw);
      tr.appendChild(tdStatus);

      // REPORT ID
      const tdId = document.createElement("td");
      tdId.textContent = reportId;
      tr.appendChild(tdId);

      // ACTIONS (VIEW + PDF)
      const tdActions = document.createElement("td");
      tdActions.style.textAlign = "right";

      if (statusKey === "completed" && reportId && reportId !== "-") {
        // VIEW PDF (opens report.html in new tab)
        const viewBtn = document.createElement("button");
        viewBtn.type = "button";
        viewBtn.className = "wd-pdf-btn";
        viewBtn.textContent = "View PDF";
        viewBtn.style.marginRight = "8px";
        viewBtn.addEventListener("click", () => {
          window.open(`/report.html?report_id=${reportId}`, "_blank");
        });
        tdActions.appendChild(viewBtn);

        // DOWNLOAD PDF
        const dlBtn = document.createElement("button");
        dlBtn.type = "button";
        dlBtn.className = "wd-pdf-btn";
        dlBtn.textContent = "Download PDF";
        dlBtn.addEventListener("click", () => downloadPdf(reportId));
        tdActions.appendChild(dlBtn);
      } else {
        tdActions.textContent = "Generating‚Ä¶";
        tdActions.className = "scan-actions-pending";
      }

      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    }
  }

  // current test wiring for DocRaptor: HTML stub + reportId
  async function downloadPdf(reportId) {
    try {
      const resp = await fetch("/.netlify/functions/docraptor-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          reportId: reportId,
          html: `
            <!doctype html>
            <html>
              <head>
                <meta charset="utf-8" />
                <title>iQWEB Report ${reportId}</title>
              </head>
              <body>
                <h1>iQWEB test PDF</h1>
                <p>This proves DocRaptor wiring works.</p>
                <p>Report ID: ${reportId}</p>
              </body>
            </html>
          `,
        }),
      });

      if (!resp.ok) {
        const text = await resp.text();
        console.error("PDF download failed", resp.status, text);
        alert("Sorry ‚Äî there was a problem generating the PDF.");
        return;
      }

      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${reportId}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("PDF download error", err);
      alert("Sorry ‚Äî there was a problem generating the PDF.");
    }
  }

  // STEP 2: latest-scan card ‚Üí view latest report
  function updateLastScanCard(record) {
    const card = document.getElementById("latest-scan-card");
    if (!card) return;

    const urlEl = document.getElementById("ls-url");
    const dateEl = document.getElementById("ls-date");
    const scoreEl = document.getElementById("ls-score");

    if (!record) {
      if (urlEl) urlEl.textContent = "No scans yet";
      if (dateEl) dateEl.textContent = "Run your first iQWEB scan to see it here.";
      if (scoreEl) scoreEl.style.display = "none";
      card.dataset.reportId = "";
      card.onclick = null;
      return;
    }

    const hostname = getHostname(record.url);
    if (urlEl) urlEl.textContent = hostname;
    if (dateEl) {
      dateEl.textContent = `Scanned on ${formatDate(
        record.created_at
      )} at ${formatTime(record.created_at)}`;
    }

    if (scoreEl) {
      if (record.score_overall != null) {
        scoreEl.textContent = record.score_overall;
        scoreEl.style.display = "inline-block";
      } else {
        scoreEl.style.display = "none";
      }
    }

    const reportId = record.report_id || record.id;
    card.dataset.reportId = reportId || "";

    card.onclick = () => {
      if (!card.dataset.reportId) return;
      window.open(
        `/report.html?report_id=${encodeURIComponent(card.dataset.reportId)}`,
        "_blank"
      );
    };
  }

  function applyFiltersAndRender() {
    const table = document.querySelector(".scan-history-table");
    const emptyNone = document.getElementById("historyEmptyNone");
    const emptyFiltered = document.getElementById("historyEmptyFiltered");

    if (!allRecords.length) {
      if (table) table.style.display = "none";
      if (emptyNone) emptyNone.style.display = "block";
      if (emptyFiltered) emptyFiltered.style.display = "none";
      renderRows([]);
      updateLastScanCard(null);
      return;
    }

    let filtered = allRecords.slice();

    if (activeStatus !== "all") {
      filtered = filtered.filter((rec) => getStatusKey(rec.status) === activeStatus);
    }

    if (searchQuery) {
      filtered = filtered.filter((rec) => {
        const haystack = [
          formatDate(rec.created_at),
          formatTime(rec.created_at),
          getHostname(rec.url),
          rec.url || "",
          rec.report_id || "",
        ]
          .join(" ")
          .toLowerCase();
        return haystack.includes(searchQuery);
      });
    }

    if (!filtered.length) {
      if (table) table.style.display = "none";
      if (emptyNone) emptyNone.style.display = "none";
      if (emptyFiltered) emptyFiltered.style.display = "block";
      renderRows([]);
      updateLastScanCard(null);
      return;
    }

    if (table) table.style.display = "table";
    if (emptyNone) emptyNone.style.display = "none";
    if (emptyFiltered) emptyFiltered.style.display = "none";

    renderRows(filtered);
    updateLastScanCard(filtered[0] || null);
  }

  async function loadScanHistory(userId) {
    let query = supabase
      .from("scan_results")
      .select(
        "id, user_id, url, status, score_overall, report_id, report_url, created_at, scan_time_ms"
      )
      .order("created_at", { ascending: false })
      .limit(100);

    if (userId) {
      query = query.eq("user_id", userId);
    }

    const { data, error } = await query;

    if (error) {
      console.error("Error loading scan history", error);
      allRecords = [];
    } else {
      allRecords = data || [];
    }

    applyFiltersAndRender();
  }

  // Expose for debugging if needed
  window.loadScanHistory = loadScanHistory;

  function setupFilters() {
    const filterPills = document.querySelectorAll(".filter-pill");
    filterPills.forEach((pill) => {
      pill.addEventListener("click", () => {
        filterPills.forEach((p) => p.classList.remove("active"));
        pill.classList.add("active");
        activeStatus = pill.dataset.status || "all";
        applyFiltersAndRender();
      });
    });
  }

  function setupSearch() {
    const searchInput = document.getElementById("historySearch");
    if (!searchInput) return;
    searchInput.addEventListener("input", () => {
      searchQuery = (searchInput.value || "").trim().toLowerCase();
      applyFiltersAndRender();
    });
  }

  async function setupSignOut() {
    const signoutLink = document.querySelector(".signout");
    if (!signoutLink) return;

    signoutLink.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        await supabase.auth.signOut();
      } catch (err) {
        console.error("Error signing out", err);
      } finally {
        window.location.href = "/index.html";
      }
    });
  }

  function setupInlineRun(user) {
    const runBtn = document.getElementById("wd-run-scan-btn");
    const urlInput = document.getElementById("wd-scan-url-input");
    if (!runBtn || !urlInput) return;

    runBtn.addEventListener("click", async () => {
      const url = (urlInput.value || "").trim();
      if (!url) {
        alert("Please enter a URL to scan.");
        urlInput.focus();
        return;
      }

      runBtn.disabled = true;
      runBtn.textContent = "Scanning‚Ä¶";

      let json;
      let res;
      try {
        res = await fetch("/.netlify/functions/run-scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url,
            userId: user?.id || null,
          }),
        });
        json = await res.json();
      } catch (err) {
        console.error("Error calling run-scan:", err);
        alert("Scan failed. Please try again.");
        runBtn.disabled = false;
        runBtn.textContent = "Run Scan";
        return;
      }

      runBtn.disabled = false;
      runBtn.textContent = "Run Scan";

      if (!res.ok || !json?.success) {
        alert("Scan failed: " + (json?.message || "Unknown error"));
        return;
      }

      // Clear URL field and refresh history
      urlInput.value = "";
      await loadScanHistory(user.id);
    });
  }

// Stripe checkout for selected plan (Linear-style)
async function startPlanCheckout(planKey) {
  const priceIds = {
    insight: "price_1SQ4knHrtPY0HwDpFHfxNdoZ",      // $29 ‚Äì 100 scans (TEST)
    intelligence: "price_1SQ4oZHrtPY0HwDpjLOnlC5k", // $75 ‚Äì 250 scans (TEST)
    impact: "price_1SQ4qUHrtPY0HwDpSDWJDBpb",       // $149 ‚Äì 500 scans (TEST)
  };

  const priceId = priceIds[planKey];
  if (!priceId) {
    alert("Invalid plan selected.");
    return;
  }

  // Use the current session (more reliable than getUser() alone)
  const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();

  const user = sessionData?.session?.user || null;

  if (sessionErr || !user) {
    console.error("startPlanCheckout: no active session", sessionErr);
    alert("Please log in again to continue.");
    window.location.href = "/login.html";
    return;
  }

  const email = user.email;
  const userId = user.id;

  try {
    const res = await fetch("/.netlify/functions/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ priceId, email, userId }),
    });

    const json = await res.json();
    if (!res.ok || !json?.url) {
      console.error("Checkout session error:", json);
      alert("Unable to start checkout. Please try again.");
      return;
    }

    window.location.href = json.url;
  } catch (err) {
    console.error("Checkout error:", err);
    alert("Checkout failed. Please try again.");
  }
}


  function handleSelectedPlan() {
    const params = new URLSearchParams(window.location.search);
    const plan = params.get("plan");
    if (!plan) return;

    const banner = document.getElementById("selected-plan-banner");
    const textEl = document.getElementById("selected-plan-text");
    const cta = document.getElementById("selected-plan-cta");
    if (!banner || !textEl || !cta) return;

    const map = {
      insight: "Insight ‚Äî $29/mo ¬∑ 100 scans",
      intelligence: "Intelligence ‚Äî $75/mo ¬∑ 250 scans",
      impact: "Impact ‚Äî $149/mo ¬∑ 500 scans",
    };

    textEl.textContent = `You selected: ${map[plan] || plan}`;
    banner.style.display = "flex";

    cta.onclick = () => startPlanCheckout(plan);
  }

  // Credit pack checkout (requires matching Netlify function)
  async function startCreditsCheckout(pack, user) {
    const activeUser = user;
    if (!activeUser) {
      alert("Please log in again to continue.");
      window.location.href = "/login.html";
      return;
    }

    const email = activeUser.email;

    try {
      const res = await fetch("/.netlify/functions/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: activeUser.id,
          email,
          type: "credits",
          pack: String(pack),
        }),
      });

      const json = await res.json();
      if (!res.ok || !json?.url) {
        console.error("Credit checkout session error:", json);
        alert("Unable to start credit purchase. Please try again.");
        return;
      }

      window.location.href = json.url;
    } catch (err) {
      console.error("Credit checkout error:", err);
      alert("Unable to start credit purchase. Please try again.");
    }
  }

function setupCreditPackButtons(user) {
  const packs = ["10", "25", "50", "100", "500"];
  packs.forEach((pack) => {
    const btn = document.getElementById(`btn-credits-${pack}`);
    if (!btn) return;
    btn.addEventListener("click", () => {
      alert("Top-ups are coming soon. For now, please choose a monthly plan.");
    });
  });
}


  document.addEventListener("DOMContentLoaded", async () => {
    const user = await requireSession();
    if (!user) return;

    // Initial load
    await loadProfile(user);
    setupFilters();
    setupSearch();
    await loadScanHistory(user.id);
    await setupSignOut();
    setupInlineRun(user);
    setupCreditPackButtons(user);
    handleSelectedPlan(); // show banner + wire checkout if ?plan= exists

    // Wire "View plans & subscribe" banner button ‚Üí main pricing
    const goToPricingBtn = document.getElementById("btn-go-to-pricing");
    if (goToPricingBtn) {
      goToPricingBtn.addEventListener("click", () => {
        window.location.href = "/index.html#pricing";
      });
    }

    // --- Handle return from Stripe checkout ---
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");
    const billingStatus = params.get("billing");

    if (sessionId || billingStatus === "success") {
      const planSummaryEl = document.getElementById("wd-plan-summary");
      if (planSummaryEl) {
        planSummaryEl.textContent =
          "Your subscription is now active. Enjoy your scans.";
      }

      // give webhook a moment then pull fresh profile
      setTimeout(() => {
        loadProfile(user);
      }, 1500);

      // clean URL so message doesn‚Äôt re-trigger
      if (window.history.replaceState) {
        const url = new URL(window.location.href);
        url.searchParams.delete("session_id");
        url.searchParams.delete("billing");
        window.history.replaceState({}, "", url.pathname + url.search);
      }
    }
  });

</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebDoctor ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-top: #050814;
      --bg-mid: #07101f;
      --bg-bot: #0b1729;
      --ink: #e8eef2;
      --ink-soft: #c7d9e7;
      --muted: #9fb1bf;
      --highlight: #5dd8ff;
      --danger: #ff6b6b;
      --box: rgba(255,255,255,0.06);
      --box2: rgba(255,255,255,0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Montserrat, sans-serif;
      background: radial-gradient(circle at top left, #10172a 0, #050814 45%, #02040a 100%);
      color: var(--ink);
      overflow-x: hidden;
    }

    /* HEADER */

    header {
      position: sticky;
      top: 0;
      z-index: 30;
      padding: 22px 40px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.1));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 26px;
    }

    .logo a {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--ink);
      text-decoration: none;
    }

    .back-link {
      font-size: 16px;
      color: var(--ink-soft);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      opacity: 0.9;
      transition: 0.2s;
    }

    .back-link span.arrow {
      font-size: 18px;
      margin-top: -1px;
    }

    .back-link:hover {
      color: var(--highlight);
      opacity: 1;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 26px;
    }

    .nav-link {
      font-size: 17px;
      font-weight: 600;
      color: var(--ink-soft);
      text-decoration: none;
      transition: 0.2s;
    }

    .nav-link.active {
      color: var(--highlight);
    }

    .nav-link:hover {
      color: var(--ink);
    }

    .user-menu {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .user-trigger {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: rgba(8,15,30,0.9);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      cursor: pointer;
      font-size: 14px;
      color: var(--ink-soft);
      outline: none;
    }

    .user-initial {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--highlight), #8be7ff);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: 800;
      font-size: 15px;
    }

    .user-email {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-caret {
      font-size: 11px;
      opacity: 0.8;
      margin-left: 4px;
    }

    .user-admin-badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      padding: 2px 6px;
      color: var(--highlight);
    }

    .user-dropdown {
      position: absolute;
      right: 0;
      top: 110%;
      background: #040712;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      min-width: 230px;
      padding: 8px;
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: 0.16s ease-out;
    }

    .user-menu:hover .user-dropdown {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .user-dropdown a,
    .user-dropdown button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      text-decoration: none;
      color: var(--ink-soft);
      transition: 0.16s;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
    }

    .user-dropdown a:hover,
    .user-dropdown button:hover {
      background: rgba(255,255,255,0.05);
      color: var(--ink);
    }

    .user-dropdown a.signout {
      color: var(--danger);
      font-weight: 600;
    }

    .user-dropdown-separator {
      height: 1px;
      margin: 6px 4px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
    }

    /* PAGE WRAP */

    .wrap {
      max-width: 1200px;
      margin: 34px auto 60px;
      padding: 0 20px 40px;
    }

    .section {
      background: var(--box);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.09);
      box-shadow: 0 0 40px rgba(0,0,0,0.45);
      padding: 32px 34px;
      margin-bottom: 30px;
    }

    .section.small {
      padding: 24px 26px;
    }

    h1 {
      font-size: 36px;
      margin: 0 0 6px;
      font-weight: 800;
      color: var(--highlight);
    }

    .subtext {
      font-size: 18px;
      color: var(--ink-soft);
      margin-bottom: 24px;
    }

    /* SUMMARY CARD */

    .summary-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 26px;
      align-items: stretch;
    }

    .summary-block {
      background: var(--box2);
      border-radius: 16px;
      padding: 22px 24px;
      border: 1px solid rgba(255,255,255,0.09);
    }

    .summary-label {
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .credits-value {
      font-size: 34px;
      font-weight: 800;
      color: var(--highlight);
      transition: color 0.15s;
    }

    .credits-value.low-credits {
      color: #fb923c;
    }

    .last-scan-site {
      font-size: 18px;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 4px;
    }

    .last-scan-meta {
      font-size: 14px;
      color: var(--ink-soft);
      margin-bottom: 8px;
    }

    .score-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(10,180,130,0.14);
      font-size: 14px;
      color: #5ffac5;
      font-weight: 600;
      margin-top: 4px;
    }

    .score-pill span.score {
      font-size: 18px;
      font-weight: 800;
    }

    .summary-actions {
      margin-top: 26px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }

    /* Run button */

    .btn-primary {
      padding: 16px 32px;
      border-radius: 14px;
      background: linear-gradient(135deg, #22c55e, #14b8a6);
      color: #000;
      font-weight: 800;
      font-size: 18px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out, opacity 0.16s;
      border: none;
      cursor: pointer;
    }

    .btn-primary span.icon {
      font-size: 20px;
      margin-top: -2px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(0,0,0,0.7);
      opacity: 0.92;
    }

    .hint-text {
      font-size: 14px;
      color: var(--muted);
    }

    /* Last scan clickable */

    .last-scan-card {
      cursor: pointer;
      transition: box-shadow 0.15s ease-out, border-color 0.15s ease-out, transform 0.12s ease-out;
    }

    .last-scan-card:hover {
      box-shadow: 0 0 40px rgba(0,0,0,0.7);
      border-color: rgba(93,216,255,0.5);
      transform: translateY(-1px);
    }

    /* LAYOUT GRID */

    .layout-grid {
      display: block; /* full-width history */
    }

    h2 {
      font-size: 24px;
      margin: 0 0 10px;
    }

    /* HISTORY HEADER / SEARCH / FILTERS */

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      margin-bottom: 10px;
    }

    .history-header-left {
      flex: 1 1 auto;
    }

    .history-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      min-width: 260px;
    }

    .filter-pills {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filter-pill {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(10,15,32,0.9);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
    }

    .filter-pill.active {
      border-color: var(--highlight);
      color: var(--ink);
      background: rgba(12,26,56,0.95);
    }

    .search-group {
      position: relative;
      width: 100%;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(4,8,18,0.9);
      color: var(--ink);
      padding: 7px 12px 7px 30px;
      font-size: 13px;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    .search-icon {
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      color: var(--muted);
      pointer-events: none;
    }

    /* TABLE */

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 14px 10px;
      font-size: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    th {
      text-align: left;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    td {
      color: var(--ink);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(95,248,187,0.12);
      color: #6cfac3;
    }

    .status-pill.pending {
      background: rgba(255,204,102,0.15);
      color: #ffd27a;
      position: relative;
      padding-left: 24px;
    }

    .status-pill.pending::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(255,210,122,0.8);
      border-top-color: transparent;
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: translateY(-50%) rotate(360deg);
      }
    }

    .action-link {
      color: var(--highlight);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      margin-right: 10px;
    }

    .action-link:hover {
      text-decoration: underline;
    }

    /* Report ID style + copy button */

    .report-id-btn {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }

    .report-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      letter-spacing: 0.04em;
      color: var(--ink-soft);
      transition: color 0.12s;
    }

    .report-id-btn:hover .report-id {
      color: var(--highlight);
    }

    /* History footer / load more */

    .history-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(7,12,24,0.9);
      color: var(--ink-soft);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      transition: 0.16s;
      cursor: pointer;
    }

    .btn-secondary.small {
      padding: 7px 14px;
      font-size: 12px;
      border-radius: 999px;
    }

    .btn-secondary:hover {
      background: rgba(15,25,42,0.98);
      color: var(--ink);
    }

    /* Empty states */

    .history-empty {
      display: none;
      margin-top: 12px;
      padding: 18px 16px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,0.2);
      background: rgba(4,8,20,0.85);
      font-size: 14px;
      color: var(--ink-soft);
    }

    .history-empty strong {
      color: var(--highlight);
    }

    /* Copy toast */

    #copyToast {
      position: fixed;
      left: 50%;
      bottom: 26px;
      transform: translateX(-50%) translateY(20px);
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(12,20,40,0.96);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--ink-soft);
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.16s ease-out, transform 0.16s ease-out;
      z-index: 60;
    }

    #copyToast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 960px) {
      header {
        padding: 18px 18px;
      }

      .header-left {
        gap: 16px;
      }

      .wrap {
        margin-top: 24px;
      }

      .summary-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .history-header {
        flex-direction: column;
        align-items: stretch;
      }

      .history-controls {
        align-items: stretch;
        min-width: 0;
      }

      .filter-pills {
        justify-content: flex-start;
      }
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 30px;
      }

      .section {
        padding: 24px 20px;
      }

      .section.small {
        padding: 20px 18px;
      }

      .subtext {
        font-size: 16px;
      }

      .user-trigger {
        padding: 6px 10px;
      }
    }
  </style>
</head>

<body>

<header>
  <div class="header-left">
    <div class="logo">
      <a href="index.html">WebDoctor</a>
    </div>
    <a class="back-link" href="index.html">
      <span class="arrow">‚Üê</span>
      <span>Back to main page</span>
    </a>
  </div>

  <div class="header-right">
    <a href="#" class="nav-link active">Dashboard</a>

    <div class="user-menu">
      <button class="user-trigger" type="button">
        <span class="user-initial" id="wd-user-initial">U</span>
        <span class="user-email" id="wd-user-email">you@example.com</span>
        <span id="wd-admin-badge" class="user-admin-badge" style="display:none;">Admin</span>
        <span class="user-caret">‚ñæ</span>
      </button>
      <div class="user-dropdown">
        <a href="#">Profile</a>
        <button type="button">Buy extra credits</button>
        <button type="button">Manage subscription &amp; invoices</button>
        <div class="user-dropdown-separator"></div>
        <button type="button">Support</button>
        <a href="https://trust.webdoctor.tech" target="_blank">Trust &amp; privacy</a>
        <div class="user-dropdown-separator"></div>
        <a href="#" class="signout">Sign out</a>
      </div>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- SUMMARY / TOP STRIP -->
  <div class="section">
    <h1>Welcome back, <span id="wd-user-name">there</span></h1>
    <div class="subtext">
      Run new scans, check your last diagnosis, and download reports ‚Äî all from one place.
    </div>

    <div class="summary-grid">
      <div class="summary-block">
        <div class="summary-label">Scans available</div>
        <div class="credits-value" id="wd-credits-count">--</div>
        <div class="hint-text" id="wd-plan-summary" style="margin-top:8px;">
          Loading your plan details‚Ä¶
        </div>
      </div>

      <div class="summary-block last-scan-card">
        <div class="summary-label">Last scan</div>
        <div class="last-scan-site">No scans yet</div>
        <div class="last-scan-meta">Run your first WebDoctor scan to see it here.</div>
        <div class="score-pill" style="display:none;">
          <span class="score">‚Äî</span>
          Overall score
        </div>
        <div class="summary-actions" style="margin-top:18px;">
          <a href="#" class="action-link" style="display:none;">View full report</a>
          <a href="#" class="action-link" style="display:none;">Download PDF</a>
        </div>
      </div>
    </div>

    <div class="summary-actions">
      <button class="btn-primary" id="wd-run-scan-btn">
        <span class="icon">‚ñ∂</span>
        <span>Run New Scan</span>
      </button>
      <div class="hint-text">
        Your plan scans are used first. If you run out, extra credits are $1 per scan. Paste a URL, we‚Äôll handle the diagnostics. No setup, no code, no plugins.
      </div>
    </div>
  </div>

  <!-- MAIN GRID: HISTORY ONLY -->

  <div class="layout-grid">

    <div class="section">
      <div class="history-header">
        <div class="history-header-left">
          <h2>Scan history</h2>
          <div class="hint-text">
            All the websites you‚Äôve scanned with WebDoctor. Open a report or download the PDF anytime.
          </div>
        </div>
        <div class="history-controls">
          <div class="filter-pills">
            <button class="filter-pill active" data-status="all">All</button>
            <button class="filter-pill" data-status="completed">Completed</button>
            <button class="filter-pill" data-status="in-progress">In progress</button>
          </div>
          <div class="search-group">
            <span class="search-icon">üîç</span>
            <input id="historySearch" class="search-input" type="search"
                   placeholder="Search scans‚Ä¶ (domain, date, ID)">
          </div>
        </div>
      </div>

      <table class="scan-history-table">
        <thead>
        <tr>
          <th>Date</th>
          <th>Website</th>
          <th>Score</th>
          <th>Status</th>
          <th>Report ID</th>
          <th style="text-align:right;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- rows injected dynamically -->
        </tbody>
      </table>

      <div id="historyEmptyNone" class="history-empty">
        <strong>No scans yet.</strong> Run your first WebDoctor scan and it will appear here.
      </div>

      <div id="historyEmptyFiltered" class="history-empty">
        <strong>No scans match your search.</strong> Try clearing filters or changing your search terms.
      </div>

      <div class="history-footer">
        <button id="loadMoreScans" type="button" class="btn-secondary small" style="display:none;">
          Load more scans
        </button>
      </div>
    </div>

  </div>

</div>

<div id="copyToast">Report ID copied to clipboard</div>

<footer style="
  position: fixed;
  right: 24px;
  bottom: 18px;
  color: rgba(231,239,245,0.45);
  font-size: 12px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  pointer-events: none;
">
  Powered by <span style="color:#5dd8ff;">iQWeb</span>
</footer>

<!-- Run Scan Modal -->
<div id="scanModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="
    background: #0d1628;
    padding: 28px;
    border-radius: 18px;
    width: 420px;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
  ">
    <h2 style="margin-top:0; color:#5dd8ff;">Run a new scan</h2>
    <p class="hint-text" style="margin-bottom:14px;">Enter a website URL to run a full WebDoctor scan.</p>

    <input id="scanUrlInput" type="text" placeholder="https://example.com" style="
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.2);
      background:#08101e;
      color:white;
      font-size:14px;
      margin-bottom:18px;
    ">

    <div style="display:flex; justify-content:flex-end; gap:12px;">
      <button id="cancelScanBtn" class="btn-secondary small" type="button">Cancel</button>
      <button id="confirmScanBtn" class="btn-primary" type="button" style="padding:10px 20px;">Run Scan</button>
    </div>
  </div>
</div>

<!-- Supabase + wiring -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://arqlambmnbrgjcvwiand.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycWxhbWJtbmJyZ2pjdndpYW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzg5NzgsImV4cCI6MjA3NzcxNDk3OH0.2uGkC8vNjy5ZttMUOKCuThtCSUNrQBGZ1-zb39sCzVU";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function requireSession() {
    const { data, error } = await supabase.auth.getSession();

    if (error) {
      console.error("Error getting session", error);
      window.location.href = "/login.html";
      return null;
    }
    if (!data.session) {
      window.location.href = "/login.html";
      return null;
    }
    return data.session.user;
  }

  async function loadProfile(user) {
    const { data, error } = await supabase
      .from("profiles")
      .select("full_name, email, credits, subscription_tier, is_admin, monthly_limit, reports_used")
      .eq("user_id", user.id)
      .maybeSingle();

    if (error) {
      console.error("Error loading profile", error);
    }

    const profile = data || {};
    const displayEmail = profile.email || user.email || "";
    const displayName = profile.full_name || displayEmail || "WebDoctor user";

    const nameEl = document.getElementById("wd-user-name");
    const emailEl = document.getElementById("wd-user-email");
    const initialEl = document.getElementById("wd-user-initial");
    const creditsEl = document.getElementById("wd-credits-count");
    const planSummaryEl = document.getElementById("wd-plan-summary");
    const adminBadgeEl = document.getElementById("wd-admin-badge");

    if (nameEl) nameEl.textContent = displayName;
    if (emailEl) emailEl.textContent = displayEmail || "Signed in";
    if (initialEl) initialEl.textContent = (displayName || "?").trim().charAt(0).toUpperCase();

    const credits = typeof profile.credits === "number" ? profile.credits : 0;
    if (creditsEl) {
      creditsEl.textContent = credits;
      creditsEl.classList.toggle("low-credits", credits <= 2);
    }

    const tier = (profile.subscription_tier || "free").toLowerCase();
    const monthlyLimit = profile.monthly_limit;
    const used = profile.reports_used || 0;

    let summary = "Free plan ¬∑ pay-per-scan credits.";
    if (tier === "trial") {
      summary = "Trial plan ¬∑ enjoy your WebDoctor test scans.";
    } else if (tier === "starter") {
      summary = monthlyLimit
        ? `Starter ¬∑ ${monthlyLimit} scans/month ‚Äî ${Math.max(monthlyLimit - used, 0)} left.`
        : "Starter plan ¬∑ monthly scans included.";
    } else if (tier === "pro") {
      summary = monthlyLimit
        ? `Pro ¬∑ ${monthlyLimit} scans/month ‚Äî ${Math.max(monthlyLimit - used, 0)} left.`
        : "Pro plan ¬∑ higher limits and priority processing.";
    } else if (tier === "agency") {
      summary = monthlyLimit
        ? `Agency ¬∑ ${monthlyLimit}+ scans/month with priority diagnostics.`
        : "Agency plan ¬∑ built for teams and client load.";
    }
    if (planSummaryEl) {
      planSummaryEl.textContent = summary;
    }

    if (adminBadgeEl) {
      adminBadgeEl.style.display = profile.is_admin ? "inline-flex" : "none";
    }
  }

  // ---- Scan history + filters/search ----

  let allRecords = [];
  let activeStatus = "all";
  let searchQuery = "";

  function formatDate(dateString) {
    if (!dateString) return "‚Äî";
    const d = new Date(dateString);
    if (Number.isNaN(d.getTime())) return "‚Äî";
    return d.toLocaleDateString(undefined, {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  function getHostname(url) {
    if (!url) return "‚Äî";
    try {
      return new URL(url).hostname;
    } catch {
      return url;
    }
  }

  function getStatusKey(status) {
    const s = (status || "").toLowerCase();
    if (s === "in_progress" || s === "pending") return "in-progress";
    if (s === "failed" || s === "error") return "failed";
    return "completed";
  }

  function getStatusLabel(status) {
    const key = getStatusKey(status);
    if (key === "in-progress") return "In progress";
    if (key === "failed") return "Failed";
    return "Completed";
  }

  function getStatusClass(status) {
    const key = getStatusKey(status);
    if (key === "in-progress") return "status-pill pending";
    if (key === "failed") return "status-pill";
    return "status-pill";
  }

  function showToast(msg) {
    const toast = document.getElementById("copyToast");
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add("visible");
    setTimeout(() => toast.classList.remove("visible"), 1500);
  }

  function renderRows(records) {
    const table = document.querySelector(".scan-history-table");
    const tbody = table?.querySelector("tbody");
    if (!tbody || !table) return;

    tbody.innerHTML = "";

    for (const rec of records) {
      const tr = document.createElement("tr");
      const statusKey = getStatusKey(rec.status);
      tr.className = "scan-row";
      tr.dataset.status = statusKey;

      const hostname = getHostname(rec.url);
      const score = rec.score_overall ?? "‚Äî";
      const statusLabel = getStatusLabel(rec.status);
      const statusClass = getStatusClass(rec.status);

      tr.innerHTML = `
        <td>${formatDate(rec.created_at)}</td>
        <td>${hostname}</td>
        <td>${score}</td>
        <td><span class="${statusClass}">${statusLabel}</span></td>
        <td>
          ${
            rec.report_id
              ? `<button type="button" class="report-id-btn" data-report-id="${rec.report_id}">
                   <span class="report-id">${rec.report_id}</span>
                 </button>`
              : '<span class="hint-text">Pending</span>'
          }
        </td>
        <td style="text-align:right;">
          ${
            rec.report_url
              ? `<a href="${rec.report_url}" target="_blank" class="action-link">PDF</a>`
              : '<span class="hint-text">Generating‚Ä¶</span>'
          }
        </td>
      `;

      tbody.appendChild(tr);
    }

    // Hook up copy buttons each time we re-render
    tbody.querySelectorAll(".report-id-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.reportId;
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(id);
          }
          showToast(`Report ID ${id} copied`);
        } catch {
          showToast("Unable to copy ID");
        }
      });
    });

    // Last-scan card click ‚Üí first PDF link
    const lastScanCard = document.querySelector(".last-scan-card");
    if (lastScanCard) {
      lastScanCard.onclick = () => {
        const firstPdf = tbody.querySelector(".action-link");
        if (firstPdf) firstPdf.click();
      };
    }
  }

  function updateLastScanCard(record) {
    const card = document.querySelector(".last-scan-card");
    if (!card) return;

    const siteEl = card.querySelector(".last-scan-site");
    const metaEl = card.querySelector(".last-scan-meta");
    const scorePill = card.querySelector(".score-pill");
    const scoreSpan = card.querySelector(".score-pill .score");
    const [viewLink, pdfLink] = card.querySelectorAll(".summary-actions .action-link");

    if (!record) {
      if (siteEl) siteEl.textContent = "No scans yet";
      if (metaEl) metaEl.textContent = "Run your first WebDoctor scan to see it here.";
      if (scorePill) scorePill.style.display = "none";
      if (viewLink) viewLink.style.display = "none";
      if (pdfLink) pdfLink.style.display = "none";
      return;
    }

    const hostname = getHostname(record.url);
    if (siteEl) siteEl.textContent = hostname;
    if (metaEl) metaEl.textContent = `Scanned on ${formatDate(record.created_at)}`;

    if (scorePill && scoreSpan) {
      if (record.score_overall != null) {
        scoreSpan.textContent = record.score_overall;
        scorePill.style.display = "inline-flex";
      } else {
        scorePill.style.display = "none";
      }
    }

    if (pdfLink) {
      if (record.report_url) {
        pdfLink.href = record.report_url;
        pdfLink.target = "_blank";
        pdfLink.style.display = "inline-flex";
      } else {
        pdfLink.style.display = "none";
      }
    }

    if (viewLink) {
      if (record.report_url) {
        viewLink.href = record.report_url;
        viewLink.target = "_blank";
        viewLink.style.display = "inline-flex";
      } else {
        viewLink.style.display = "none";
      }
    }
  }

  function applyFiltersAndRender() {
    const table = document.querySelector(".scan-history-table");
    const emptyNone = document.getElementById("historyEmptyNone");
    const emptyFiltered = document.getElementById("historyEmptyFiltered");

    if (!allRecords.length) {
      if (table) table.style.display = "none";
      if (emptyNone) emptyNone.style.display = "block";
      if (emptyFiltered) emptyFiltered.style.display = "none";
      renderRows([]);
      return;
    }

    let filtered = allRecords.slice();

    if (activeStatus !== "all") {
      filtered = filtered.filter((rec) => getStatusKey(rec.status) === activeStatus);
    }

    if (searchQuery) {
      filtered = filtered.filter((rec) => {
        const haystack = [
          formatDate(rec.created_at),
          getHostname(rec.url),
          rec.url || "",
          rec.report_id || ""
        ]
          .join(" ")
          .toLowerCase();
        return haystack.includes(searchQuery);
      });
    }

    if (!filtered.length) {
      if (table) table.style.display = "none";
      if (emptyNone) emptyNone.style.display = "none";
      if (emptyFiltered) emptyFiltered.style.display = "block";
      renderRows([]);
      return;
    }

    if (table) table.style.display = "table";
    if (emptyNone) emptyNone.style.display = "none";
    if (emptyFiltered) emptyFiltered.style.display = "none";

    renderRows(filtered);
  }

  async function loadScanHistory(userId) {
    let query = supabase
      .from("scan_results")
      .select("id, user_id, url, status, score_overall, report_id, report_url, created_at, scan_time_ms")
      .order("created_at", { ascending: false })
      .limit(100);

    if (userId) {
      query = query.eq("user_id", userId);
    }

    const { data, error } = await query;

    if (error) {
      console.error("Error loading scan history", error);
      allRecords = [];
    } else {
      allRecords = data || [];
    }

    applyFiltersAndRender();
    updateLastScanCard(allRecords[0] || null);
  }

  // Expose for debugging if needed
  window.loadScanHistory = loadScanHistory;

  function setupFilters() {
    const filterPills = document.querySelectorAll(".filter-pill");
    filterPills.forEach((pill) => {
      pill.addEventListener("click", () => {
        filterPills.forEach((p) => p.classList.remove("active"));
        pill.classList.add("active");
        activeStatus = pill.dataset.status || "all";
        applyFiltersAndRender();
      });
    });
  }

  function setupSearch() {
    const searchInput = document.getElementById("historySearch");
    if (!searchInput) return;
    searchInput.addEventListener("input", () => {
      searchQuery = (searchInput.value || "").trim().toLowerCase();
      applyFiltersAndRender();
    });
  }

  async function setupSignOut() {
    const signoutLink = document.querySelector(".signout");
    if (!signoutLink) return;

    signoutLink.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        await supabase.auth.signOut();
      } catch (err) {
        console.error("Error signing out", err);
      } finally {
        window.location.href = "/index.html";
      }
    });
  }

  function setupScanModal(user) {
    const runBtn = document.getElementById("wd-run-scan-btn");
    const modal = document.getElementById("scanModal");
    const cancelBtn = document.getElementById("cancelScanBtn");
    const confirmBtn = document.getElementById("confirmScanBtn");
    const urlInput = document.getElementById("scanUrlInput");

    if (!runBtn || !modal || !cancelBtn || !confirmBtn || !urlInput) return;

    // Open modal
    runBtn.addEventListener("click", (e) => {
      e.preventDefault();
      modal.style.display = "flex";
      urlInput.value = "";
      urlInput.focus();
    });

    // Close modal
    cancelBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // Run scan
    confirmBtn.addEventListener("click", async () => {
      const url = urlInput.value.trim();
      if (!url) {
        alert("Please enter a URL");
        return;
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = "Scanning‚Ä¶";

      let json;
      let res;

      try {
        res = await fetch("/.netlify/functions/run-scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url,
            userId: user?.id || null
          })
        });
        json = await res.json();
      } catch (err) {
        console.error("Error calling run-scan:", err);
        alert("Scan failed. Please try again.");
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Run Scan";
        return;
      }

      confirmBtn.disabled = false;
      confirmBtn.textContent = "Run Scan";

      if (!res.ok || !json?.success) {
        alert("Scan failed: " + (json?.message || "Unknown error"));
        return;
      }

      modal.style.display = "none";

      // Reload scan history for this user
      await loadScanHistory(user.id);
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const user = await requireSession();
    if (!user) return;

    await loadProfile(user);
    setupFilters();
    setupSearch();
    await loadScanHistory(user.id);
    await setupSignOut();
    setupScanModal(user);
  });
</script>

</body>
</html>
